<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body onload="startGame()">
    <div id="app"></div>
</body>

</html>
<script>
    // model.js
    const model = {
        app: {
            app: document.getElementById('app'),
        },
        state: {
            battle: {
                isActive: false,
                isFightingTrainer: false,
                isUserTurn: true,
                hasBeenWon: false,
                battleText: '',
                wildPokemon: null,
                selectedPokemon: null,
            },
            ui: {
                clickEnabled: true,
                currentView: 'map', // 'map', 'battle', 'inventory'
            },
            inventory: {
                availablePokemons: [],
                caughtPokemons: [],
            }
        },
        data: {
            allPokemons: [
                { name: 'Pikachu', level: 25, img: 'img/pokemon1.png', hp: 100 },
                { name: 'Squirtle', level: 15, img: 'img/pokemon2.png', hp: 50 },
                { name: 'Charmander', level: 20, img: 'img/pokemon3.png', hp: 75 },
                { name: 'Evee', level: 13, img: 'img/pokemon4.png', hp: 40 },
                { name: 'Bulbasour', level: 15, img: 'img/pokemon5.png', hp: 50 },
                { name: 'Jigglypuff', level: 30, img: 'img/pokemon6.png', hp: 120 },
                { name: 'Meowth', level: 20, img: 'img/pokemon7.png', hp: 75 },
                { name: 'Psyduck', level: 20, img: 'img/pokemon8.png', hp: 78 },
                { name: 'Dragonair', level: 42, img: 'img/pokemon9.png', hp: 150 },
                { name: 'Snorlax', level: 50, img: 'img/pokemon10.png', hp: 250 },
            ],
            allTrainers: [
                { name: 'Ash', img: 'img/pokemonTrainerIdle.png' },
                { name: 'Markus', img: 'img/pokemonEnemyTrainerIdle.png' }
            ],
            enemyTrainersPokemons: [
                { name: 'Bulbasour', level: 20, img: 'img/pokemon5.png', hp: 50 },
                { name: 'Jigglypuff', level: 25, img: 'img/pokemon6.png', hp: 105 },
                { name: 'Dragonair', level: 45, img: 'img/pokemon9.png', hp: 240 },
            ]
        },
    };

    // Shorthand reference for easier access
    const gameState = model.state;

    // Helper functions
    function deepCopyPokemon(pokemonArray) {
        return pokemonArray.map(pokemon => ({ ...pokemon }));
    }

    function randomNumber(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function calculateDamage(level) {
        return Math.floor(Math.random() * 9 * level) + 1;
    }

    // Pokemon management
    function initGame() {
        // Initialize available Pokemon
        gameState.inventory.availablePokemons = deepCopyPokemon(model.data.allPokemons);

        // Start with Pikachu if no Pokemon caught yet
        if (gameState.inventory.caughtPokemons.length === 0) {
            const pikachu = model.data.allPokemons.find(pokemon => pokemon.name === 'Pikachu');
            gameState.inventory.caughtPokemons.push({ ...pikachu });
        }
    }

    function catchPokemon() {
        // Add currently battled Pokemon to caught list
        gameState.inventory.caughtPokemons.push({ ...gameState.battle.wildPokemon });
        resetBattle();
        updateView();
    }

    function healPokemon(index) {
        // Find original Pokemon stats and restore HP
        const pokemon = gameState.inventory.caughtPokemons[index];
        const originalPokemon = model.data.allPokemons.find(p => p.name === pokemon.name);
        pokemon.hp = originalPokemon.hp;
        updateView();
    }

    function selectPokemon(index) {
        // Select Pokemon for battle
        gameState.battle.selectedPokemon = gameState.inventory.caughtPokemons[index];
        updateView();
    }

    // Battle management
    function startWildBattle() {
        // Reset battle state
        resetBattle();

        // Choose random wild Pokemon
        const randomIndex = randomNumber(0, gameState.inventory.availablePokemons.length - 1);
        gameState.battle.wildPokemon = { ...gameState.inventory.availablePokemons[randomIndex] };

        // Set battle state
        gameState.battle.isActive = true;
        gameState.battle.isFightingTrainer = false;

        setTimeout(() => {
            alert(gameState.battle.wildPokemon.name + ' wants to fight');
            updateView();
        }, 500);
    }

    function startTrainerBattle() {
        // Reset battle state
        resetBattle();

        // Set up trainer battle
        gameState.battle.isActive = true;
        gameState.battle.isFightingTrainer = true;
        gameState.battle.wildPokemon = { ...model.data.enemyTrainersPokemons[0] };

        updateView();
    }

    function playerAttack() {
        if (gameState.battle.hasBeenWon || !gameState.ui.clickEnabled) return;

        // Calculate and apply damage
        const damage = calculateDamage(gameState.battle.selectedPokemon.level);
        gameState.battle.wildPokemon.hp -= damage;
        gameState.battle.battleText = `${gameState.battle.selectedPokemon.name} hit for ${damage}`;

        // Disable clicking during enemy turn
        gameState.ui.clickEnabled = false;

        // Check battle status and continue if not over
        checkBattleStatus();
        if (!gameState.battle.hasBeenWon) {
            enemyAttack();
        }

        updateView();
    }

    function enemyAttack() {
        setTimeout(() => {
            if (gameState.battle.hasBeenWon) return;

            // Calculate and apply damage
            const damage = calculateDamage(gameState.battle.wildPokemon.level);
            gameState.battle.selectedPokemon.hp -= damage;
            gameState.battle.battleText = `${gameState.battle.wildPokemon.name} hit for ${damage}`;

            // Re-enable clicking for player's turn
            gameState.ui.clickEnabled = true;

            checkBattleStatus();
            updateView();
        }, 1000);
    }

    function checkBattleStatus() {
        if (gameState.battle.hasBeenWon) return;

        if (gameState.battle.wildPokemon.hp <= 0) {
            // Player won
            gameState.battle.battleText = `${model.data.allTrainers[0].name} and ${gameState.battle.selectedPokemon.name} have won`;
            gameState.battle.hasBeenWon = true;
            gameState.battle.selectedPokemon.level += 1;

            setTimeout(() => resetBattle(), 3000);
        } else if (gameState.battle.selectedPokemon.hp <= 0) {
            // Enemy won
            gameState.battle.battleText = `Wild ${gameState.battle.wildPokemon.name} has won`;
            gameState.battle.hasBeenWon = true;

            setTimeout(() => resetBattle(), 3000);
        }
    }

    function runAway() {
        resetBattle();
    }

    function resetBattle() {
        // Reset all battle-related state
        gameState.battle.isActive = false;
        gameState.battle.isFightingTrainer = false;
        gameState.battle.isUserTurn = true;
        gameState.battle.hasBeenWon = false;
        gameState.battle.battleText = '';
        gameState.battle.wildPokemon = null;
        gameState.battle.selectedPokemon = null;
        gameState.ui.clickEnabled = true;

        // Refresh inventory
        gameState.inventory.availablePokemons = deepCopyPokemon(model.data.allPokemons);

        updateView();
    }

    // View helpers
    function renderPokemonCard(pokemon, options = {}) {
        const {
            onClick = '',
            index = null,
            showHealButton = false
        } = options;

        return `
    <div ${onClick ? `onclick="${onClick}"` : ''} class="pokemon-card">
      <div>${pokemon.name}</div>
      <img src="${pokemon.img}">
      <div>Level: ${pokemon.level}</div>
      <div>Hp: ${pokemon.hp}</div>
      ${showHealButton && index !== null ?
                `<button onclick="healPokemon(${index})">heal</button>` :
                ''}
    </div>
  `;
    }

    function renderInventory() {
        return gameState.inventory.caughtPokemons.map((pokemon, index) =>
            renderPokemonCard(pokemon, {
                onClick: gameState.battle.isActive ?
                    `selectPokemon(${index})` : '',
                index,
                showHealButton: !gameState.battle.isActive
            })
        ).join('');
    }

    function renderBattleArea() {
        if (!gameState.battle.isActive) return '';

        return `
    <div class="battle-area">
      ${gameState.battle.selectedPokemon ? `
        <div class="selected-pokemon">
          ${renderPokemonCard(gameState.battle.selectedPokemon)}
          ${gameState.ui.clickEnabled ?
                    `<button onclick="playerAttack()">attack</button>` :
                    ''}
        </div>` : `<div></div>`}
        
      <div class="battle-text">
        ${gameState.battle.battleText || ''}
      </div>
        
      ${gameState.battle.wildPokemon ? `
        <div class="wild-pokemon">
          ${renderPokemonCard(gameState.battle.wildPokemon)}
        </div>` : '<div></div>'}
    </div>
  `;
    }

    function renderControlButtons() {
        if (gameState.battle.isActive) {
            return `
      ${gameState.battle.isFightingTrainer ?
                    `<button onclick="runAway()">Run Away</button>` :
                    `<button onclick="catchPokemon()">Catch the pokemon</button>`}
      <button onclick="updateView()">Select Pokemon</button>
    `;
        } else {
            return `
      <button ${gameState.ui.clickEnabled ?
                    `onclick="startWildBattle()"` :
                    ''}>Go into the grass</button>
      <button ${gameState.ui.clickEnabled ?
                    'onclick="updateView()"' :
                    ''}>View my pokemon</button>
      <button ${gameState.ui.clickEnabled ?
                    'onclick="startTrainerBattle()"' :
                    ''}>Fight another trainer</button>
    `;
        }
    }

    function renderTrainers() {
        return `
    <div class="trainers-area">
      <div class="user-trainer">
        <div>name: ${model.data.allTrainers[0].name}</div> 
        <img src="${model.data.allTrainers[0].img}" alt=""> 
      </div>
      ${gameState.battle.isFightingTrainer && gameState.battle.isActive ? `
        <div class="enemy-trainer">
          <div>name: ${model.data.allTrainers[1].name}</div>
          <img src="${model.data.allTrainers[1].img}" alt="">
        </div>
      ` : ''}
    </div>
  `;
    }

    // Main view update function
    function updateView() {
        const html = `
    <div class="game-container">
      <div class="control-buttons">
        ${renderControlButtons()}
      </div>
      
      ${renderBattleArea()}
      
      <div class="trainers-pokemon"> 
        ${renderInventory()}
      </div>
      
      ${renderTrainers()}
    </div>
  `;

        model.app.app.innerHTML = html;
    }

    // Initialize the game
    function startGame() {
        initGame();
        updateView();
    }

</script>